<html>
<head>
	<style type="text/css">
		.item {
			border: 1px solid #000;
			height: 70px;
			display: block;
			padding: 20px;
			margin: 10px 0;
		}
	</style>

	<script src="/node_modules/incremental-dom/dist/incremental-dom.js"></script>
	<script src="/index.es5.js"></script>

	<script src="reducers.js"></script>
	<script src="updater.js"></script>
</head>
<body>
	<div id="approot"></div>

<script>
"use scrict";

var approot = document.getElementById('approot')

function randomItem() {
	return {
		id: Math.random() * Date.now(),
		width: 200 + Math.floor(Math.random() * 800),
		color: '#' + Math.random().toString(16).substr(-6)
	}
}

// central state
var state = {
	items: [
		randomItem()
	],
	menu: {
		addManyCount: 1000,
	},
	persist: true
}

// fragments
function item(i, index) {
	var shouldUpdate = up.check(i)
	var computedStyle = 'background: ' + i.color + '; width: ' + i.width + 'px';

	var root = ['div.item', { key: i.id, style: computedStyle, __placeholder: !shouldUpdate }]
	if (shouldUpdate) {
		root = root.concat([
			['div',
				['input', {
					type: 'text',
					value: i.color,
					oninput: reducers.item.colorChange, ref: i
				}]
			],
			['div',
				['input', {
					type: 'range', min: '200', max: '1000',
					value: new String(i.width),
					oninput: reducers.item.widthChange, ref: i
				}]
			],
			['div.content', i.width],
			['div',
				['button', { onclick: reducers.item.remove, ref: i }, 'remove']
			]
		])
	}

	return root
}

function list(s) {
	return ['span'].concat(s.items.map(item))
}

function menu(s) {
	if (up.check(s.menu)) {
		return ['span', { key: 'appmenu', __placeholder: false },
					['div#menu',
						['input', { oninput: reducers.list.addManyCount, value: s.menu.addManyCount }],
						['button', { onclick:	reducers.list.addMany },
							'add to state.items' + ' (' + s.items.length + ')'
						],
						['button', { onclick: reducers.list.flush }, 'flush state.items'],
						['button', { onclick: reducers.state.flush }, 'flush localStorage.state'],
						['button', { onclick: reducers.state.animate }, 'animate']
					]
				]
	} else {
		return ['span', { key: 'appmenu', __placeholder: true }]
	}
}

function app(s) {
	return ['span',
				menu(s),
				list(s)
			]
}

// render update
function update() {
	function render() {
		jsonml(app(state))
	}

	IncrementalDOM.patch(approot, render)
}

// state persistance
if (localStorage.state) state = JSON.parse(localStorage.state)
window.__persistState = true
window.addEventListener('beforeunload', function () {
	if (__persistState) localStorage.state = JSON.stringify(state)
})

// bootstrap updates
var up = Updater(update)
up.batch()
</script>
</body>
</html>
